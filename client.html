<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Installation – Display</title>
<style>
  /* Local fonts */
  @font-face {
    font-family: 'Space Mono';
    src: url('/fonts/SpaceMono-Regular.woff2') format('woff2');
    font-weight: 400;
    font-style: normal;
  }
  @font-face {
    font-family: 'Space Mono';
    src: url('/fonts/SpaceMono-Bold.woff2') format('woff2');
    font-weight: 700;
    font-style: normal;
  }
  @font-face {
    font-family: 'Playfair Display';
    src: url('/fonts/PlayfairDisplay-Regular.woff2') format('woff2');
    font-weight: 400;
    font-style: normal;
  }
  @font-face {
    font-family: 'Playfair Display';
    src: url('/fonts/PlayfairDisplay-Bold.woff2') format('woff2');
    font-weight: 700;
    font-style: normal;
  }
  @font-face {
    font-family: 'Playfair Display';
    src: url('/fonts/PlayfairDisplay-Black.woff2') format('woff2');
    font-weight: 900;
    font-style: normal;
  }
  @font-face {
    font-family: 'JetBrains Mono';
    src: url('/fonts/JetBrainsMono-Regular.woff2') format('woff2');
    font-weight: 400;
    font-style: normal;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    background: #0a0a0a;
    color: #ffffff;
    font-family: 'Space Mono', monospace;
    cursor: none;
    user-select: none;
  }

  #canvas {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* --- Idle state: subtle breathing animation --- */
  #idle-indicator {
    position: absolute;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.7rem;
    color: rgba(255,255,255,0.15);
    letter-spacing: 0.3em;
    text-transform: uppercase;
    animation: breathe 4s ease-in-out infinite;
  }

  #client-id {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 0.6rem;
    color: rgba(255,255,255,0.08);
    font-family: 'JetBrains Mono', monospace;
  }

  @keyframes breathe {
    0%, 100% { opacity: 0.15; }
    50% { opacity: 0.4; }
  }

  /* --- Content layers --- */
  .content-layer {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
    z-index: 10;
  }

  .content-layer.pos-top { align-items: flex-start; padding-top: 80px; }
  .content-layer.pos-bottom { align-items: flex-end; padding-bottom: 80px; }
  .content-layer.pos-left { justify-content: flex-start; padding-left: 80px; }
  .content-layer.pos-right { justify-content: flex-end; padding-right: 80px; }

  /* --- Text styles --- */
  .display-text {
    font-family: 'Playfair Display', serif;
    text-align: center;
    line-height: 1.3;
    max-width: 90%;
    word-wrap: break-word;
  }

  /* --- Image styles --- */
  .display-image {
    max-width: 90%;
    max-height: 90vh;
    object-fit: contain;
    border-radius: 2px;
  }

  .display-image.fit-cover {
    width: 100%;
    height: 100%;
    object-fit: cover;
    max-width: 100%;
    max-height: 100%;
    border-radius: 0;
  }

  /* Tiled image - shows a portion of a larger image */
  .display-tile {
    position: absolute;
    inset: 0;
    background-repeat: no-repeat;
  }

  /* --- Animations --- */

  /* Fade */
  .anim-fade-in {
    animation: fadeIn 1.5s ease-out forwards;
  }
  .anim-fade-out {
    animation: fadeOut 1s ease-in forwards;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }
  @keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
  }

  /* Slide up */
  .anim-slide-up {
    animation: slideUp 1s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }
  @keyframes slideUp {
    from { opacity: 0; transform: translateY(60px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Typewriter */
  .typewriter-cursor::after {
    content: '▌';
    animation: blink 0.8s step-end infinite;
    color: rgba(255,255,255,0.6);
  }
  @keyframes blink {
    50% { opacity: 0; }
  }

  /* Glitch effect */
  .effect-glitch {
    animation: glitch 0.3s linear infinite;
  }
  @keyframes glitch {
    0% { transform: translate(0); filter: hue-rotate(0deg); }
    20% { transform: translate(-3px, 3px); filter: hue-rotate(90deg); }
    40% { transform: translate(3px, -3px); filter: hue-rotate(180deg); }
    60% { transform: translate(-2px, -2px); filter: hue-rotate(270deg); }
    80% { transform: translate(2px, 2px); filter: hue-rotate(360deg); }
    100% { transform: translate(0); }
  }

  /* Pulse effect */
  .effect-pulse {
    animation: pulse 0.6s ease-in-out 3;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.08); }
  }

  /* Wave effect */
  .effect-wave .display-text {
    animation: wave 2s ease-in-out;
  }
  @keyframes wave {
    0% { transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-20px) rotate(-2deg); }
    50% { transform: translateY(0) rotate(0deg); }
    75% { transform: translateY(-10px) rotate(1deg); }
    100% { transform: translateY(0) rotate(0deg); }
  }

  /* Flash effect */
  .effect-flash {
    animation: flash 0.15s linear 3;
  }
  @keyframes flash {
    0%, 100% { background: #0a0a0a; }
    50% { background: #ffffff; }
  }

  /* Noise overlay */
  #noise {
    position: fixed;
    inset: 0;
    z-index: 999;
    pointer-events: none;
    opacity: 0.03;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    background-size: 200px 200px;
  }

  /* Fullscreen prompt */
  #fs-prompt {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    cursor: pointer;
  }
  #fs-prompt span {
    font-size: 1.2rem;
    color: rgba(255,255,255,0.5);
    letter-spacing: 0.2em;
    text-transform: uppercase;
    animation: breathe 2s ease-in-out infinite;
  }
  #fs-prompt.hidden { display: none; }

  /* Connection status */
  #status-dot {
    position: absolute;
    top: 15px;
    left: 20px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #333;
    transition: background 0.5s;
  }
  #status-dot.connected { background: #2ecc40; }
  #status-dot.disconnected { background: #ff4136; }
</style>
</head>
<body>

<div id="fs-prompt" onclick="goFullscreen()">
  <span>Klick für Vollbild</span>
</div>

<div id="noise"></div>
<div id="status-dot"></div>
<div id="client-id"></div>
<div id="canvas">
  <div id="idle-indicator">bereit</div>
</div>

<script>
// --- Fullscreen ---
function goFullscreen() {
  document.documentElement.requestFullscreen().catch(() => {});
  document.getElementById('fs-prompt').classList.add('hidden');
}

// --- WebSocket ---
let ws;
let clientInfo = { id: 0, name: 'Laptop' };
let reconnectTimer;

function connect() {
  const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${protocol}//${location.host}?role=client`);

  ws.onopen = () => {
    console.log('Connected');
    document.getElementById('status-dot').className = 'connected';
    if (reconnectTimer) clearInterval(reconnectTimer);
  };

  ws.onclose = () => {
    document.getElementById('status-dot').className = 'disconnected';
    reconnectTimer = setTimeout(connect, 2000);
  };

  ws.onerror = () => ws.close();

  ws.onmessage = (event) => {
    try {
      const msg = JSON.parse(event.data);
      handleMessage(msg);
    } catch (e) {
      console.error('Parse error:', e);
    }
  };
}

function handleMessage(msg) {
  switch (msg.type) {
    case 'identity':
      clientInfo = msg;
      document.getElementById('client-id').textContent = `#${msg.id} ${msg.name}`;
      document.title = `Display #${msg.id}`;
      break;

    case 'content-history':
      msg.items.forEach((item, i) => {
        setTimeout(() => handleMessage(item), i * 200);
      });
      break;

    case 'show-text':
      showText(msg);
      break;

    case 'show-image':
      showImage(msg);
      break;

    case 'show-tiled-image':
      showTiledImage(msg);
      break;

    case 'show-color':
      document.body.style.background = msg.color;
      break;

    case 'clear':
      clearContent(msg.style);
      break;

    case 'effect':
      applyEffect(msg.effect, msg.duration);
      break;
  }
}

function showText(msg) {
  hideIdle();
  const layer = createLayer(msg.position);
  const el = document.createElement('div');
  el.className = 'display-text';
  el.style.fontSize = msg.fontSize || '2rem';
  el.style.color = msg.color || '#ffffff';

  if (msg.style === 'typewriter') {
    el.classList.add('typewriter-cursor');
    layer.appendChild(el);
    typewriterEffect(el, msg.text, () => {
      el.classList.remove('typewriter-cursor');
    });
  } else if (msg.style === 'slide') {
    el.textContent = msg.text;
    el.classList.add('anim-slide-up');
    layer.appendChild(el);
  } else {
    el.textContent = msg.text;
    el.classList.add('anim-fade-in');
    layer.appendChild(el);
  }

  document.getElementById('canvas').appendChild(layer);
}

function showImage(msg) {
  hideIdle();
  const layer = createLayer(msg.position);
  const img = document.createElement('img');
  img.className = 'display-image anim-fade-in';
  if (msg.fit === 'cover') img.classList.add('fit-cover');
  img.src = msg.url;
  img.onerror = () => {
    // Show error as text
    const errEl = document.createElement('div');
    errEl.className = 'display-text anim-fade-in';
    errEl.style.fontSize = '1rem';
    errEl.style.color = 'rgba(255,100,100,0.5)';
    errEl.textContent = '⚠ Bild nicht ladbar';
    layer.appendChild(errEl);
  };
  layer.appendChild(img);
  document.getElementById('canvas').appendChild(layer);
}

function showTiledImage(msg) {
  hideIdle();
  const { tile, url, style, preserveAspect } = msg;
  const { col, row, cols, rows } = tile;

  if (preserveAspect) {
    // Load image to get dimensions for aspect-ratio-aware tiling
    const img = new Image();
    img.onload = () => {
      const imgRatio = img.naturalWidth / img.naturalHeight;
      const vpRatio = window.innerWidth / window.innerHeight;

      // Calculate scaled size to "cover" the combined display area
      // while maintaining aspect ratio
      let scaledW, scaledH;

      // Try scaling by width first
      scaledW = cols;
      scaledH = cols / imgRatio * vpRatio;

      if (scaledH < rows) {
        // Width scaling doesn't cover height, scale by height instead
        scaledH = rows;
        scaledW = rows * imgRatio / vpRatio;
      }

      // Background size as percentage of viewport
      const bgWidthPct = scaledW * 100;
      const bgHeightPct = scaledH * 100;

      // Center offset (excess on each side)
      const xExcess = scaledW - cols;
      const yExcess = scaledH - rows;

      // This tile's position in the scaled image
      const tileX = xExcess / 2 + col;
      const tileY = yExcess / 2 + row;

      // Convert to background-position percentage
      const xPos = scaledW > 1 ? (tileX / (scaledW - 1)) * 100 : 50;
      const yPos = scaledH > 1 ? (tileY / (scaledH - 1)) * 100 : 50;

      createTileElement(url, bgWidthPct, bgHeightPct, xPos, yPos);
    };
    img.onerror = () => {
      // Fallback to stretch mode on error
      createTileElement(url, cols * 100, rows * 100,
        cols > 1 ? (col / (cols - 1)) * 100 : 0,
        rows > 1 ? (row / (rows - 1)) * 100 : 0
      );
    };
    img.src = url;
  } else {
    // Original stretch behavior
    const bgWidthPct = cols * 100;
    const bgHeightPct = rows * 100;
    const xPos = cols > 1 ? (col / (cols - 1)) * 100 : 0;
    const yPos = rows > 1 ? (row / (rows - 1)) * 100 : 0;
    createTileElement(url, bgWidthPct, bgHeightPct, xPos, yPos);
  }
}

function createTileElement(url, bgWidth, bgHeight, xPos, yPos) {
  const layer = document.createElement('div');
  layer.className = 'content-layer';

  const tileEl = document.createElement('div');
  tileEl.className = 'display-tile anim-fade-in';

  tileEl.style.backgroundSize = `${bgWidth}% ${bgHeight}%`;
  tileEl.style.backgroundPosition = `${xPos}% ${yPos}%`;
  tileEl.style.backgroundImage = `url('${url}')`;

  layer.appendChild(tileEl);
  document.getElementById('canvas').appendChild(layer);
}

function clearContent(style) {
  const layers = document.querySelectorAll('.content-layer');
  layers.forEach(layer => {
    layer.classList.add('anim-fade-out');
    setTimeout(() => layer.remove(), 1000);
  });
  setTimeout(() => {
    document.body.style.background = '#0a0a0a';
    showIdle();
  }, 1100);
}

function applyEffect(effect, duration) {
  const canvas = document.getElementById('canvas');
  canvas.classList.add(`effect-${effect}`);
  if (effect === 'flash') {
    document.body.classList.add('effect-flash');
    setTimeout(() => document.body.classList.remove('effect-flash'), duration);
  }
  setTimeout(() => canvas.classList.remove(`effect-${effect}`), duration);
}

// --- Helpers ---

function createLayer(position) {
  const layer = document.createElement('div');
  layer.className = 'content-layer';
  if (position && position !== 'center') {
    layer.classList.add(`pos-${position}`);
  }
  return layer;
}

function typewriterEffect(el, text, onComplete) {
  let i = 0;
  const speed = 50 + Math.random() * 30;
  function type() {
    if (i < text.length) {
      el.textContent += text.charAt(i);
      i++;
      setTimeout(type, speed + (Math.random() * 20 - 10));
    } else {
      if (onComplete) onComplete();
    }
  }
  type();
}

function hideIdle() {
  const idle = document.getElementById('idle-indicator');
  if (idle) idle.style.display = 'none';
}

function showIdle() {
  const idle = document.getElementById('idle-indicator');
  if (idle) idle.style.display = 'block';
}

// --- Start ---
connect();

// Prevent sleep / screensaver with occasional activity
setInterval(() => {
  if (ws && ws.readyState === 1) {
    ws.send(JSON.stringify({ type: 'heartbeat' }));
  }
}, 30000);
</script>
</body>
</html>
